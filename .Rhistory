return(c(HTDBH_EQ = HTDBH_EQ, Dbw = Dbw))}
# Chunk 7
#FVS HT-DBH (Table 4.1.1 in FVS-NE guide)
FVSNE.HTDBH <- function(SPP,HTDBH_EQ,DBH,Dbw){
if(SPP=='BF'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='TA'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RN'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WP'){ca_a1=2108.8442; ca_a2=5.6595; ca_a3=-0.1856; w_a1=4.609; w_a2=-6.1896}
else if(SPP=='WC'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='EH'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RM'){ca_a1=268.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
else if(SPP=='SM'){ca_a1=209.8555; ca_a2=2.9528; ca_a3=-0.3679; w_a1=4.4834; w_a2=-4.5431}
else if(SPP=='YB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='PB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='GB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='AB'){ca_a1=526.1393; ca_a2=3.8923; ca_a3=-0.2259; w_a1=4.4772; w_a2=-4.7206}
else if(SPP=='WA'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='BA'){ca_a1=178.9308; ca_a2=4.9286; ca_a3=-0.6378; w_a1=4.6155; w_a2=-6.2945}
else if(SPP=='QA'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2= -4.9918}
else if(SPP=='BP'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2= -6.4497}
else if(SPP=='BT'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='OK'){ca_a1=196.0565; ca_a2=3.0067; ca_a3=-0.385; w_a1=4.5225; w_a2=-4.9401}
else if(SPP=='EL'){ca_a1=1005.8067; ca_a2=4.6474; ca_a3=-0.2034; w_a1=4.3744; w_a2=-4.5257}
else if(SPP=='HH'){ca_a1=109.7324; ca_a2=2.2503; ca_a3=-0.413; w_a1=4.0322; w_a2=-3.0833}
else{ca_a1=68.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
HT = ifelse(HTDBH_EQ =="C" & DBH < 3.0,(4.5+ca_a1*exp(-1*ca_a2*3**ca_a3)-4.51*(DBH-Dbw)/(3-Dbw))+4.51,
ifelse(HTDBH_EQ =="C" & DBH >= 3.0,4.5+ca_a1*exp(-1*ca_a2*DBH**ca_a3),
4.5+exp(w_a1+w_a2/(DBH+1))))
return(HT=HT)}
aa <- sapply(tree$FVSspID, FVSNE.SPP)
tree <- tree %>%
mutate(HTDBH_EQ = t(aa)[,1],
Dbw = as.numeric(t(aa)[,2]),
HT_PRED_FVS = mapply(FVSNE.HTDBH, SPP = FVSspID,
HTDBH_EQ = HTDBH_EQ,
DBH = dbh,
Dbw = Dbw))
ggplot(tree, aes(x = dbh, y = HT, col = FVSspID)) +
geom_point() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
tree_ht <- tree %>%
pivot_longer(cols=c(HT, HT_PRED_FVS), names_to = "Height_model", values_to = "height_feet") %>%
mutate(Height_model = ifelse(Height_model == "HT", "Observed height", "FVS-predicted height"))
ggplot(tree_ht, aes(x = height_feet, fill = Height_model)) +
geom_density(alpha = 0.1) +
labs (x = "Height (feet)") +
theme(panel.background = element_rect(fill = "NA"),
axis.line = element_line(color="black"),
legend.title = element_blank(),
legend.position = c(0.8, 0.8))
ggplot(tree, aes(x = dbh, y = HT)) +
geom_point() +
stat_smooth() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
p.ht.fvs <- ggplot(tree, aes(x = HT_PRED_FVS, y = (HT-HT_PRED_FVS))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted FVS-NE height (ft)',
y = 'Bias (ft)',
title = "FVS-Northeast")
p.ht.mixed <- ggplot(tree, aes(x = HT_PRED_MIXED, y = (HT-HT_PRED_MIXED))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted random-effects height (ft)',
y = 'Bias (ft)',
title = "Mixed model (fixed + random effects)")
library(patchwork)
(p.ht.fvs + p.ht.mixed)
library(patchwork)
p.ht.fvs + p.ht.mixed
# Chunk 1
library(tidyverse)
# Chunk 2
tree_full <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_TreeData.csv')
ht <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_HeightCrownData.csv')
sp <- read_csv('C://Users//matt//Documents//Arbor//Projects//z_Archived//Penobscot//Penobscot_species_codes.csv')
# Chunk 3
years <- tree_full %>%
group_by(MU) %>%
summarize(last_inv = max(Inv))
tree_last_inv <- inner_join(tree_full, years) %>%
filter(Inv == last_inv)
ht_last_inv <- inner_join(ht, years) %>%
filter(Inv == last_inv) %>%
select(Inv, MU, Plot, TreeNum, HT, BLC, Rad0, Rad90, Rad180, Rad270, Comments) %>%
rename(Comments_ht = Comments)
tree <- full_join(tree_last_inv, ht_last_inv, by = c("MU", "Plot", "TreeNum","Inv")) %>%
select(-c(ExpNum, DClass, last_inv))
tree <- full_join(tree, sp, by = c("USFSspID")) %>%
drop_na(KCode) %>%
select(-c(SpeciesName)) %>%
filter(dbh >= 4.5)
# Chunk 4
# Select only live trees
tree <- tree %>%
mutate(KCode1 = str_sub(KCode, 1, -3),
alive1 = ifelse(KCode1 %in% c("1", "2", "3", "4", "5", "7", "9"), 1, 0),
KCode2 = str_sub(KCode, 2, -2),
alive2 = ifelse(KCode2 == "0", 1, 0)) %>%
filter(alive1 == 1 & alive2 == 1)
# Chunk 5
ggplot(tree, aes(x = dbh, y = HT, col = FVSspID)) +
geom_point() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
# Chunk 6
# Species function
FVSNE.SPP <- function(SPP){
if(SPP == 'BF'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'TA'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'WS'){HTDBH_EQ = 'C'; Dbw = 0.2}
else if(SPP == 'RS'){HTDBH_EQ = 'C'; Dbw = 0.2}
else if(SPP == 'RN'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'WP'){HTDBH_EQ = 'C'; Dbw = 0.4}
else if(SPP == 'WC'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'EH'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'RM'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'SM'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'YB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'PB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'GB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'AB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'WA'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'BA'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'QA'){HTDBH_EQ = 'W'; Dbw = 0.3}
else if(SPP == 'BP'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'BT'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'OK'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'EL'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'HH'){HTDBH_EQ = 'W'; Dbw = 0.2}
else{HTDBH_EQ = 'W'; Dbw = 0.1}
return(c(HTDBH_EQ = HTDBH_EQ, Dbw = Dbw))}
# Chunk 7
#FVS HT-DBH (Table 4.1.1 in FVS-NE guide)
FVSNE.HTDBH <- function(SPP,HTDBH_EQ,DBH,Dbw){
if(SPP=='BF'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='TA'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RN'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WP'){ca_a1=2108.8442; ca_a2=5.6595; ca_a3=-0.1856; w_a1=4.609; w_a2=-6.1896}
else if(SPP=='WC'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='EH'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RM'){ca_a1=268.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
else if(SPP=='SM'){ca_a1=209.8555; ca_a2=2.9528; ca_a3=-0.3679; w_a1=4.4834; w_a2=-4.5431}
else if(SPP=='YB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='PB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='GB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='AB'){ca_a1=526.1393; ca_a2=3.8923; ca_a3=-0.2259; w_a1=4.4772; w_a2=-4.7206}
else if(SPP=='WA'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='BA'){ca_a1=178.9308; ca_a2=4.9286; ca_a3=-0.6378; w_a1=4.6155; w_a2=-6.2945}
else if(SPP=='QA'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2= -4.9918}
else if(SPP=='BP'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2= -6.4497}
else if(SPP=='BT'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='OK'){ca_a1=196.0565; ca_a2=3.0067; ca_a3=-0.385; w_a1=4.5225; w_a2=-4.9401}
else if(SPP=='EL'){ca_a1=1005.8067; ca_a2=4.6474; ca_a3=-0.2034; w_a1=4.3744; w_a2=-4.5257}
else if(SPP=='HH'){ca_a1=109.7324; ca_a2=2.2503; ca_a3=-0.413; w_a1=4.0322; w_a2=-3.0833}
else{ca_a1=68.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
HT = ifelse(HTDBH_EQ =="C" & DBH < 3.0,(4.5+ca_a1*exp(-1*ca_a2*3**ca_a3)-4.51*(DBH-Dbw)/(3-Dbw))+4.51,
ifelse(HTDBH_EQ =="C" & DBH >= 3.0,4.5+ca_a1*exp(-1*ca_a2*DBH**ca_a3),
4.5+exp(w_a1+w_a2/(DBH+1))))
return(HT=HT)}
aa <- sapply(tree$FVSspID, FVSNE.SPP)
tree <- tree %>%
mutate(HTDBH_EQ = t(aa)[,1],
Dbw = as.numeric(t(aa)[,2]),
HT_PRED_FVS = mapply(FVSNE.HTDBH, SPP = FVSspID,
HTDBH_EQ = HTDBH_EQ,
DBH = dbh,
Dbw = Dbw))
# Chunk 8
tree_ht <- tree %>%
pivot_longer(cols=c(HT, HT_PRED_FVS), names_to = "Height_model", values_to = "height_feet") %>%
mutate(Height_model = ifelse(Height_model == "HT", "Observed height", "FVS-predicted height"))
ggplot(tree_ht, aes(x = height_feet, fill = Height_model)) +
geom_density(alpha = 0.1) +
labs (x = "Height (feet)") +
theme(panel.background = element_rect(fill = "NA"),
axis.line = element_line(color="black"),
legend.title = element_blank(),
legend.position = c(0.8, 0.8))
# Chunk 9
p.ht <- ggplot(tree, aes(x = dbh, y = HT)) +
geom_point() +
stat_smooth() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
p.ht
# Chunk 10
library(lme4)
# Chunk 11
ht.lme <- lmer(HT ~ dbh + (1 | FVSspID/MU/Plot),
data = tree)
summary(ht.lme)
# Chunk 12
tree <- tree %>%
mutate(HT_PRED_MIXED = predict(ht.lme, tree, re.form = NULL, allow.new.levels = TRUE))
# Chunk 13
p.ht.fvs <- ggplot(tree, aes(x = HT_PRED_FVS, y = (HT-HT_PRED_FVS))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted FVS-NE height (ft)',
y = 'Bias (ft)',
title = "FVS-Northeast")
p.ht.mixed <- ggplot(tree, aes(x = HT_PRED_MIXED, y = (HT-HT_PRED_MIXED))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted random-effects height (ft)',
y = 'Bias (ft)',
title = "Mixed model (fixed + random effects)")
library(patchwork)
p.ht.fvs + p.ht.mixed
p.ht.fvs <- ggplot(tree, aes(x = HT_PRED_FVS, y = (HT-HT_PRED_FVS))) +
geom_point() +
stat_smooth(se = F) +
scale_y_continuous(limits = c(-50, 30)) +
labs(x = 'Predicted FVS-NE height (ft)',
y = 'Bias (ft)',
title = "FVS-Northeast")
p.ht.mixed <- ggplot(tree, aes(x = HT_PRED_MIXED, y = (HT-HT_PRED_MIXED))) +
geom_point() +
stat_smooth(se = F) +
scale_y_continuous(limits = c(-50, 30)) +
labs(x = 'Predicted random-effects height (ft)',
y = 'Bias (ft)',
title = "Mixed model (fixed + random effects)")
library(patchwork)
p.ht.fvs + p.ht.mixed
library(tidyverse)
tree_full <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_TreeData.csv')
ht <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_HeightCrownData.csv')
sp <- read_csv('C://Users//matt//Documents//Arbor//Projects//z_Archived//Penobscot//Penobscot_species_codes.csv')
tree_full <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_TreeData.csv')
ht <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_HeightCrownData.csv')
sp <- read_csv('C://Users//matt//Documents//Arbor//Projects//z_Archived//Penobscot//Penobscot_species_codes.csv')
# Select only live trees
tree <- tree %>%
mutate(KCode1 = str_sub(KCode, 1, -3),
alive1 = ifelse(KCode1 %in% c("1", "2", "3", "4", "5", "7", "9"), 1, 0),
KCode2 = str_sub(KCode, 2, -2),
alive2 = ifelse(KCode2 == "0", 1, 0)) %>%
filter(alive1 == 1 & alive2 == 1)
ggplot(tree, aes(x = dbh, y = HT, col = FVSspID)) +
geom_point() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
# Chunk 1
library(tidyverse)
# Chunk 2
tree_full <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_TreeData.csv')
ht <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_HeightCrownData.csv')
sp <- read_csv('C://Users//matt//Documents//Arbor//Projects//z_Archived//Penobscot//Penobscot_species_codes.csv')
# Chunk 3
years <- tree_full %>%
group_by(MU) %>%
summarize(last_inv = max(Inv))
tree_last_inv <- inner_join(tree_full, years) %>%
filter(Inv == last_inv)
ht_last_inv <- inner_join(ht, years) %>%
filter(Inv == last_inv) %>%
select(Inv, MU, Plot, TreeNum, HT, BLC, Rad0, Rad90, Rad180, Rad270, Comments) %>%
rename(Comments_ht = Comments)
tree <- full_join(tree_last_inv, ht_last_inv, by = c("MU", "Plot", "TreeNum","Inv")) %>%
select(-c(ExpNum, DClass, last_inv))
tree <- full_join(tree, sp, by = c("USFSspID")) %>%
drop_na(KCode) %>%
select(-c(SpeciesName)) %>%
filter(dbh >= 4.5)
# Chunk 4
# Select only live trees
tree <- tree %>%
mutate(KCode1 = str_sub(KCode, 1, -3),
alive1 = ifelse(KCode1 %in% c("1", "2", "3", "4", "5", "7", "9"), 1, 0),
KCode2 = str_sub(KCode, 2, -2),
alive2 = ifelse(KCode2 == "0", 1, 0)) %>%
filter(alive1 == 1 & alive2 == 1)
library(kableExtra)
tree %>%
head() %>%
kbl(booktabs = T) %>%
kable_styling() %>%
column_spec(1, bold = T) %>%
kable_paper(full_width = F)
tree %>%
head() %>%
select(MU, Year, TreeNum, dbh, Plot, HT, FVSspID) %>%
kbl(booktabs = T) %>%
kable_styling() %>%
column_spec(1, bold = T) %>%
kable_paper(full_width = F)
tree %>%
head() %>%
select(MU, Year, TreeNum, dbh, Plot, HT, FVSspID) %>%
relocate(MU, Plot, Year, TreeNum,  FVSspID, dbh, HT) %>%
kbl(booktabs = T) %>%
kable_styling() %>%
column_spec(1, bold = T) %>%
kable_paper(full_width = F)
tree %>%
sample_n() %>%
select(MU, Year, TreeNum, dbh, Plot, HT, FVSspID) %>%
relocate(MU, Plot, Year, TreeNum,  FVSspID, dbh, HT) %>%
kbl(booktabs = T) %>%
kable_styling() %>%
column_spec(1, bold = T) %>%
kable_paper(full_width = F)
tree %>%
sample_n(size = 10) %>%
select(MU, Year, TreeNum, dbh, Plot, HT, FVSspID) %>%
relocate(MU, Plot, Year, TreeNum,  FVSspID, dbh, HT) %>%
kbl(booktabs = T) %>%
kable_styling() %>%
column_spec(1, bold = T) %>%
kable_paper(full_width = F)
library(kableExtra)
tree %>%
sample_n(size = 10) %>%
select(MU, Year, TreeNum, dbh, Plot, HT, FVSspID) %>%
relocate(MU, Plot, Year, TreeNum,  FVSspID, dbh, HT) %>%
kbl(booktabs = T) %>%
kable_styling() %>%
column_spec(1, bold = T) %>%
kable_paper(full_width = F)
library(kableExtra)
tree %>%
sample_n(size = 10) %>%
select(MU, Year, TreeNum, dbh, Plot, HT, FVSspID) %>%
relocate(MU, Plot, Year, TreeNum,  FVSspID, dbh, HT) %>%
kbl(booktabs = T) %>%
kable_styling() %>%
column_spec(1, bold = T) %>%
kable_paper(full_width = F)
ggplot(tree, aes(x = dbh, y = HT, col = FVSspID)) +
geom_point() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
tree_ht <- tree %>%
pivot_longer(cols=c(HT, HT_PRED_FVS), names_to = "Height_model", values_to = "height_feet") %>%
mutate(Height_model = ifelse(Height_model == "HT", "Observed height", "FVS-predicted height"))
# Chunk 1
library(tidyverse)
# Chunk 2
tree_full <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_TreeData.csv')
ht <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_HeightCrownData.csv')
sp <- read_csv('C://Users//matt//Documents//Arbor//Projects//z_Archived//Penobscot//Penobscot_species_codes.csv')
# Chunk 3
years <- tree_full %>%
group_by(MU) %>%
summarize(last_inv = max(Inv))
tree_last_inv <- inner_join(tree_full, years) %>%
filter(Inv == last_inv)
ht_last_inv <- inner_join(ht, years) %>%
filter(Inv == last_inv) %>%
select(Inv, MU, Plot, TreeNum, HT, BLC, Rad0, Rad90, Rad180, Rad270, Comments) %>%
rename(Comments_ht = Comments)
tree <- full_join(tree_last_inv, ht_last_inv, by = c("MU", "Plot", "TreeNum","Inv")) %>%
select(-c(ExpNum, DClass, last_inv))
tree <- full_join(tree, sp, by = c("USFSspID")) %>%
drop_na(KCode) %>%
select(-c(SpeciesName)) %>%
filter(dbh >= 4.5)
# Chunk 4
# Select only live trees
tree <- tree %>%
mutate(KCode1 = str_sub(KCode, 1, -3),
alive1 = ifelse(KCode1 %in% c("1", "2", "3", "4", "5", "7", "9"), 1, 0),
KCode2 = str_sub(KCode, 2, -2),
alive2 = ifelse(KCode2 == "0", 1, 0)) %>%
filter(alive1 == 1 & alive2 == 1)
# Chunk 5
library(kableExtra)
tree %>%
sample_n(size = 10) %>%
select(MU, Year, TreeNum, dbh, Plot, HT, FVSspID) %>%
relocate(MU, Plot, Year, TreeNum,  FVSspID, dbh, HT) %>%
kbl(booktabs = T) %>%
kable_styling() %>%
column_spec(1, bold = T) %>%
kable_paper(full_width = F)
# Chunk 6
library(tidyverse)
# Chunk 7
ggplot(tree, aes(x = dbh, y = HT, col = FVSspID)) +
geom_point() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
# Chunk 8
FVSNE.SPP <- function(SPP){
if(SPP == 'BF'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'TA'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'WS'){HTDBH_EQ = 'C'; Dbw = 0.2}
else if(SPP == 'RS'){HTDBH_EQ = 'C'; Dbw = 0.2}
else if(SPP == 'RN'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'WP'){HTDBH_EQ = 'C'; Dbw = 0.4}
else if(SPP == 'WC'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'EH'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'RM'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'SM'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'YB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'PB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'GB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'AB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'WA'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'BA'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'QA'){HTDBH_EQ = 'W'; Dbw = 0.3}
else if(SPP == 'BP'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'BT'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'OK'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'EL'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'HH'){HTDBH_EQ = 'W'; Dbw = 0.2}
else{HTDBH_EQ = 'W'; Dbw = 0.1}
return(c(HTDBH_EQ = HTDBH_EQ, Dbw = Dbw))}
# Chunk 9
#FVS HT-DBH (Table 4.1.1 in FVS-NE guide)
FVSNE.HTDBH <- function(SPP,HTDBH_EQ,DBH,Dbw){
if(SPP=='BF'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='TA'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RN'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WP'){ca_a1=2108.8442; ca_a2=5.6595; ca_a3=-0.1856; w_a1=4.609; w_a2=-6.1896}
else if(SPP=='WC'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='EH'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RM'){ca_a1=268.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
else if(SPP=='SM'){ca_a1=209.8555; ca_a2=2.9528; ca_a3=-0.3679; w_a1=4.4834; w_a2=-4.5431}
else if(SPP=='YB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='PB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='GB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='AB'){ca_a1=526.1393; ca_a2=3.8923; ca_a3=-0.2259; w_a1=4.4772; w_a2=-4.7206}
else if(SPP=='WA'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='BA'){ca_a1=178.9308; ca_a2=4.9286; ca_a3=-0.6378; w_a1=4.6155; w_a2=-6.2945}
else if(SPP=='QA'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2= -4.9918}
else if(SPP=='BP'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2= -6.4497}
else if(SPP=='BT'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='OK'){ca_a1=196.0565; ca_a2=3.0067; ca_a3=-0.385; w_a1=4.5225; w_a2=-4.9401}
else if(SPP=='EL'){ca_a1=1005.8067; ca_a2=4.6474; ca_a3=-0.2034; w_a1=4.3744; w_a2=-4.5257}
else if(SPP=='HH'){ca_a1=109.7324; ca_a2=2.2503; ca_a3=-0.413; w_a1=4.0322; w_a2=-3.0833}
else{ca_a1=68.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
HT = ifelse(HTDBH_EQ =="C" & DBH < 3.0,(4.5+ca_a1*exp(-1*ca_a2*3**ca_a3)-4.51*(DBH-Dbw)/(3-Dbw))+4.51,
ifelse(HTDBH_EQ =="C" & DBH >= 3.0,4.5+ca_a1*exp(-1*ca_a2*DBH**ca_a3),
4.5+exp(w_a1+w_a2/(DBH+1))))
return(HT=HT)}
# Chunk 10
aa <- sapply(tree$FVSspID, FVSNE.SPP)
tree <- tree %>%
mutate(HTDBH_EQ = t(aa)[,1],
Dbw = as.numeric(t(aa)[,2]),
HT_PRED_FVS = mapply(FVSNE.HTDBH, SPP = FVSspID,
HTDBH_EQ = HTDBH_EQ,
DBH = dbh,
Dbw = Dbw))
tree_ht <- tree %>%
pivot_longer(cols=c(HT, HT_PRED_FVS), names_to = "Height_model", values_to = "height_feet") %>%
mutate(Height_model = ifelse(Height_model == "HT", "Observed height", "FVS-predicted height"))
ggplot(tree_ht, aes(x = height_feet, fill = Height_model)) +
geom_density(alpha = 0.1) +
labs (x = "Height (feet)") +
theme(panel.background = element_rect(fill = "NA"),
axis.line = element_line(color="black"),
legend.title = element_blank(),
legend.position = c(0.8, 0.8))
p.ht <- ggplot(tree, aes(x = dbh, y = HT)) +
geom_point() +
stat_smooth() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
p.ht
library(kableExtra)
tree %>%
sample_n(size = 10) %>%
select(MU, Year, TreeNum, dbh, Plot, HT, FVSspID) %>%
relocate(MU, Plot, Year, TreeNum,  FVSspID, dbh, HT) %>%
kbl(booktabs = T) %>%
kable_styling() %>%
column_spec(1, bold = T) %>%
kable_paper(full_width = F)
p.ht <- ggplot(tree, aes(x = dbh, y = HT)) +
geom_point() +
stat_smooth() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
p.ht
ht.lme <- lmer(HT ~ dbh + (1 | FVSspID/MU/Plot),
data = tree)
library(lme4)
ht.lme <- lmer(HT ~ dbh + (1 | FVSspID/MU/Plot),
data = tree)
summary(ht.lme)
tree <- tree %>%
mutate(HT_PRED_MIXED = predict(ht.lme, tree, re.form = NULL, allow.new.levels = TRUE))
p.ht.fvs <- ggplot(tree, aes(x = HT_PRED_FVS, y = (HT-HT_PRED_FVS))) +
geom_point() +
stat_smooth(se = F) +
scale_y_continuous(limits = c(-50, 30)) +
labs(x = 'Predicted FVS-NE height (ft)',
y = 'Bias (ft)',
title = "FVS-Northeast")
p.ht.mixed <- ggplot(tree, aes(x = HT_PRED_MIXED, y = (HT-HT_PRED_MIXED))) +
geom_point() +
stat_smooth(se = F) +
scale_y_continuous(limits = c(-50, 30)) +
labs(x = 'Predicted random-effects height (ft)',
y = 'Bias (ft)',
title = "Mixed model (fixed + random effects)")
library(patchwork)
p.ht.fvs + p.ht.mixed
blogdown:::serve_site()
blogdown:::serve_site()
