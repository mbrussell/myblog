else if(SPP=='ST'){HTDBH_EQ='W';Dbw=0.1;SPPGR=28; BAMAX=150; LCW_EQ='Bechtold'; MCW_EQ='Bechtold'}
else if(SPP=='AI'){HTDBH_EQ='W';Dbw=0.1;SPPGR=28; BAMAX=150; LCW_EQ='Bechtold'; MCW_EQ='Bechtold'}
else if(SPP=='SE'){HTDBH_EQ='W';Dbw=0.1;SPPGR=28; BAMAX=170; LCW_EQ='Bechtold'; MCW_EQ='Bechtold'}
else if(SPP=='AH'){HTDBH_EQ='C';Dbw=0.2;SPPGR=28; BAMAX=170; LCW_EQ='Bechtold'; MCW_EQ='Bechtold'}
else if(SPP=='DW'){HTDBH_EQ='W';Dbw=0.1;SPPGR=28; BAMAX=150; LCW_EQ='Bechtold'; MCW_EQ='Bechtold'}
else if(SPP=='HT'){HTDBH_EQ='W';Dbw=0.1;SPPGR=28; BAMAX=170; LCW_EQ='Bechtold'; MCW_EQ='Bechtold'}
else if(SPP=='HH'){HTDBH_EQ='W';Dbw=0.2;SPPGR=28; BAMAX=170; LCW_EQ='Bechtold'; MCW_EQ='Bechtold'}
else if(SPP=='PL'){HTDBH_EQ='W';Dbw=0.2;SPPGR=28; BAMAX=150; LCW_EQ='Bragg'; MCW_EQ='Bragg'}
else if(SPP=='PR'){HTDBH_EQ='W';Dbw=0.1;SPPGR=28; BAMAX=150; LCW_EQ='Bragg'; MCW_EQ='Bragg'}
else{HTDBH_EQ='W';Dbw=0.1;SPPGR=1; BAMAX=240; LCW_EQ='Bechtold'; MCW_EQ='Ek'}
return(c(HTDBH_EQ=HTDBH_EQ,Dbw=Dbw,SPPGR=SPPGR,BAMAX=BAMAX,LCW_EQ=LCW_EQ,MCW_EQ=MCW_EQ))}
# Chunk 7
#FVS HT-DBH (Table 4.1.1 in FVS-NE guide)
FVSNE.HTDBH=function(SPP,HTDBH_EQ,DBH,Dbw){
if(SPP=='BF'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='TA'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='NS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='BS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='PI'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RN'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WP'){ca_a1=2108.8442; ca_a2=5.6595; ca_a3=-0.1856; w_a1=4.609; w_a2=-6.1896}
else if(SPP=='LP'){ca_a1=243.8606; ca_a2=4.2846; ca_a3=-0.4713; w_a1=4.6897; w_a2=-6.8801}
else if(SPP=='VP'){ca_a1=926.1803; ca_a2=4.4621; ca_a3=-0.2005; w_a1=4.4718; w_a2=-5.0078}
else if(SPP=='WC'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='AW'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RC'){ca_a1=926.1803; ca_a2=4.4621; ca_a3=-0.2005; w_a1=4.4718; w_a2=-5.0078}
else if(SPP=='OC'){ca_a1=926.1803; ca_a2=4.4621; ca_a3=-0.2005; w_a1=4.4718; w_a2=-5.0078}
else if(SPP=='EH'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='HM'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='OP'){ca_a1=208.7773; ca_a2=3.7281; ca_a3=-0.4109; w_a1=4.3898; w_a2=-5.7183}
else if(SPP=='JP'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='SP'){ca_a1=444.0922; ca_a2=4.1188; ca_a3=-0.3062; w_a1=4.6271; w_a2=-6.4095}
else if(SPP=='TM'){ca_a1=208.7773; ca_a2=3.7281; ca_a3=-0.4109; w_a1=4.3898; w_a2=-5.7183}
else if(SPP=='PP'){ca_a1=208.7773; ca_a2=3.7281; ca_a3=-0.4109; w_a1=4.3898; w_a2=-5.7183}
else if(SPP=='PD'){ca_a1=142.7468; ca_a2=3.9726; ca_a3=-0.5871; w_a1=4.5457; w_a2=-6.8}
else if(SPP=='SC'){ca_a1=142.7468; ca_a2=3.9726; ca_a3=-0.5871; w_a1=4.5457; w_a2=-6.8}
else if(SPP=='OS'){ca_a1=212.7933; ca_a2=3.4715; ca_a3=-0.3259; w_a1=4.0374; w_a2=-4.2964}
else if(SPP=='RM'){ca_a1=268.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
else if(SPP=='SM'){ca_a1=209.8555; ca_a2=2.9528; ca_a3=-0.3679; w_a1=4.4834; w_a2=-4.5431}
else if(SPP=='BM'){ca_a1=209.8555; ca_a2=2.9528; ca_a3=-0.3679; w_a1=4.4834; w_a2=-4.5431}
else if(SPP=='SV'){ca_a1=80.5118; ca_a2=26.9833; ca_a3=-2.022; w_a1=4.5991; w_a2=-6.6706}
else if(SPP=='YB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='SB'){ca_a1=68.9223; ca_a2=43.3383; ca_a3=-2.4445; w_a1=4.4522; w_a2=-4.5758}
else if(SPP=='RB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='PB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='GB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='HI'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2=-4.9918}
else if(SPP=='PH'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2=-4.9918}
else if(SPP=='SL'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2=-4.9918}
else if(SPP=='SH'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2=-4.9918}
else if(SPP=='MH'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2=-4.9918}
else if(SPP=='AB'){ca_a1=526.1393; ca_a2=3.8923; ca_a3=-0.2259; w_a1=4.4772; w_a2=-4.7206}
else if(SPP=='AS'){ca_a1=251.4043; ca_a2=3.2692; ca_a3=-0.3591; w_a1=4.4819; w_a2=-4.5314}
else if(SPP=='WA'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='BA'){ca_a1=178.9308; ca_a2=4.9286; ca_a3=-0.6378; w_a1=4.6155; w_a2=-6.2945}
else if(SPP=='GA'){ca_a1=404.9692; ca_a2=3.3902; ca_a3=-0.2551; w_a1=4.6155; w_a2=-6.2945}
else if(SPP=='PA'){ca_a1=251.4043; ca_a2=3.2692; ca_a3=-0.3591; w_a1=4.4819; w_a2=-4.5314}
else if(SPP=='YP'){ca_a1=625.7697; ca_a2=3.8732; ca_a3=-0.2335; w_a1=4.6892; w_a2= -4.9605}
else if(SPP=='SU'){ca_a1=290.9055; ca_a2=3.624; ca_a3=-0.372; w_a1=4.592; w_a2= -5.1719}
else if(SPP=='CT'){ca_a1=660.1997; ca_a2=3.9208; ca_a3=-0.2112; w_a1=4.6067; w_a2= -5.203}
else if(SPP=='QA'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2= -4.9918}
else if(SPP=='BP'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2= -6.4497}
else if(SPP=='EC'){ca_a1=190.9797; ca_a2=3.6928; ca_a3=-0.5273; w_a1=4.9396; w_a2=-8.1838}
else if(SPP=='BT'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='PY'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='BC'){ca_a1=364.0248; ca_a2=3.5599; ca_a3=-0.2726; w_a1=4.3286; w_a2=-4.0922}
else if(SPP=='WO'){ca_a1=170.1331; ca_a2=3.2782; ca_a3=-0.4874; w_a1=4.5463; w_a2=-5.2287}
else if(SPP=='BR'){ca_a1=196.0565; ca_a2=3.0067; ca_a3=-0.385; w_a1=4.5225; w_a2=-4.9401}
else if(SPP=='CK'){ca_a1=72.7907; ca_a2=3.6707; ca_a3=-1.0988; w_a1=4.342; w_a2=-5.1193}
else if(SPP=='PO'){ca_a1=765.2908; ca_a2=4.2238; ca_a3=-0.1897; w_a1=4.2496; w_a2=-4.8061}
else if(SPP=='OK'){ca_a1=196.0565; ca_a2=3.0067; ca_a3=-0.385; w_a1=4.5225; w_a2=-4.9401}
else if(SPP=='SO'){ca_a1=196.0565; ca_a2=3.0067; ca_a3=-0.385; w_a1=4.5225; w_a2=-4.9401}
else if(SPP=='QI'){ca_a1=94.5447; ca_a2=3.4203; ca_a3=-0.8188; w_a1=4.4618; w_a2=-4.8786}
else if(SPP=='WK'){ca_a1=470.0617; ca_a2=3.7889; ca_a3=-0.2512; w_a1=4.5577; w_a2=-4.9595}
else if(SPP=='PN'){ca_a1=196.0565; ca_a2=3.0067; ca_a3=-0.385; w_a1=4.5225; w_a2=-4.9401}
else if(SPP=='CO'){ca_a1=94.5447; ca_a2=3.4203; ca_a3=-0.8188; w_a1=4.4618; w_a2=-4.8786}
else if(SPP=='SW'){ca_a1=182.6306; ca_a2=3.129; ca_a3=-0.4639; w_a1=4.7342; w_a2=-6.2674}
else if(SPP=='SN'){ca_a1=281.3413; ca_a2=3.517; ca_a3=-0.3336; w_a1=4.6135; w_a2=-5.7613}
else if(SPP=='RO'){ca_a1=700.0636; ca_a2=4.1061; ca_a3=-0.2139; w_a1=4.5202; w_a2=-4.8896}
else if(SPP=='SK'){ca_a1=150.43; ca_a2=3.1327; ca_a3=-0.4993; w_a1=4.5142; w_a2=-5.2205}
else if(SPP=='BO'){ca_a1=224.7163; ca_a2=3.1165; ca_a3=-0.3598; w_a1=4.4747; w_a2=-4.8698}
else if(SPP=='CB'){ca_a1=182.6306; ca_a2=3.129; ca_a3=-0.4639; w_a1=4.7342; w_a2=-6.2674}
else if(SPP=='OH'){ca_a1=109.7324; ca_a2=2.2503; ca_a3=-0.413; w_a1=4.0322; w_a2=-3.0833}
else if(SPP=='BU'){ca_a1=293.5715; ca_a2=3.5226; ca_a3=-0.3512; w_a1=4.582; w_a2=-5.0903}
else if(SPP=='YY'){ca_a1=293.5715; ca_a2=3.5226; ca_a3=-0.3512; w_a1=4.582; w_a2=-5.0903}
else if(SPP=='WR'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='HK'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else if(SPP=='PS'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else if(SPP=='HY'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else if(SPP=='BN'){ca_a1=285.8798; ca_a2=3.5214; ca_a3=-0.3194; w_a1=4.5018; w_a2=-5.6123}
else if(SPP=='WN'){ca_a1=93.7104; ca_a2=3.6575; ca_a3=-0.8825; w_a1=4.5018; w_a2=-5.6123}
else if(SPP=='OO'){ca_a1=109.7324; ca_a2=2.2503; ca_a3=-0.413; w_a1=4.0322; w_a2=-3.0833}
else if(SPP=='MG'){ca_a1=585.6609; ca_a2=3.4197; ca_a3=-0.1766; w_a1=4.4004; w_a2=-4.7519}
else if(SPP=='MV'){ca_a1=184.1932; ca_a2=2.8457; ca_a3=-0.3695; w_a1=4.3609; w_a2=-4.1423}
else if(SPP=='AP'){ca_a1=574.0201; ca_a2=3.8637; ca_a3=-0.1632; w_a1=3.9678; w_a2=-3.251}
else if(SPP=='WT'){ca_a1=163.9728; ca_a2=2.7682; ca_a3=-0.441; w_a1=4.333; w_a2=-4.5383}
else if(SPP=='BG'){ca_a1=319.9788; ca_a2=3.6731; ca_a3=-0.3065; w_a1=4.3802; w_a2=-4.7903}
else if(SPP=='SD'){ca_a1=690.4918; ca_a2=4.1598; ca_a3=-0.1861; w_a1=4.1352; w_a2=-3.745}
else if(SPP=='PW'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else if(SPP=='SY'){ca_a1=644.3568; ca_a2=3.9205; ca_a3=-0.2144; w_a1=4.6355; w_a2=-5.2776}
else if(SPP=='WL'){ca_a1=190.9797; ca_a2=3.6928; ca_a3=-0.5273; w_a1=4.9396; w_a2=-8.1838}
else if(SPP=='BK'){ca_a1=880.2845; ca_a2=4.5964; ca_a3=-0.2182; w_a1=4.4299; w_a2=-4.992}
else if(SPP=='BL'){ca_a1=408.2772; ca_a2=3.8181; ca_a3=-0.2721; w_a1=4.4911; w_a2=-5.7928}
else if(SPP=='SS'){ca_a1=755.1038; ca_a2=4.395; ca_a3=-0.2178; w_a1=4.3383; w_a2=-4.5018}
else if(SPP=='BW'){ca_a1=293.5715; ca_a2=3.5226; ca_a3=-0.3512; w_a1=4.582; w_a2=-5.0903}
else if(SPP=='WB'){ca_a1=293.5715; ca_a2=3.5226; ca_a3=-0.3512; w_a1=4.582; w_a2=-5.0903}
else if(SPP=='EL'){ca_a1=1005.8067; ca_a2=4.6474; ca_a3=-0.2034; w_a1=4.3744; w_a2=-4.5257}
else if(SPP=='AE'){ca_a1=418.5942; ca_a2=3.1704; ca_a3=-0.1896; w_a1=4.6008; w_a2=-7.2732}
else if(SPP=='RL'){ca_a1=1337.5472; ca_a2=4.4895; ca_a3=-0.1475; w_a1=4.6238; w_a2=-7.4847}
else if(SPP=='NC'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else if(SPP=='BE'){ca_a1=285.8798; ca_a2=3.5214; ca_a3=-0.3194; w_a1=4.5018; w_a2=-5.6123}
else if(SPP=='ST'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else if(SPP=='AI'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else if(SPP=='SE'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else if(SPP=='AH'){ca_a1=109.7324; ca_a2=2.2503; ca_a3=-0.413; w_a1=4.0322; w_a2=-3.0833}
else if(SPP=='DW'){ca_a1=863.0501; ca_a2=4.3856; ca_a3=-0.1481; w_a1=3.7301; w_a2=-2.7758}
else if(SPP=='HT'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else if(SPP=='HH'){ca_a1=109.7324; ca_a2=2.2503; ca_a3=-0.413; w_a1=4.0322; w_a2=-3.0833}
else if(SPP=='PL'){ca_a1=574.0201; ca_a2=3.8637; ca_a3=-0.1632; w_a1=3.9678; w_a2=-3.251}
else if(SPP=='PR'){ca_a1=484.753; ca_a2=3.9393; ca_a3=-0.26; w_a1=4.4207; w_a2=-5.1435}
else{ca_a1=68.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
HT = ifelse(HTDBH_EQ=="C" & DBH < 3.0,(4.5+ca_a1*exp(-1*ca_a2*3**ca_a3)-4.51*(DBH-Dbw)/(3-Dbw))+4.51,
ifelse(HTDBH_EQ=="C" & DBH >= 3.0,4.5+ca_a1*exp(-1*ca_a2*DBH**ca_a3),
4.5+exp(w_a1+w_a2/(DBH+1))))
return(HT=HT)}
aa <- sapply(tree$FVSspID, FVSNE.SPP)
tree <- tree %>%
mutate(HTDBH_EQ = t(aa)[,1],
Dbw = as.numeric(t(aa)[,2]),
HT_PRED_FVS = mapply(FVSNE.HTDBH, SPP = FVSspID,
HTDBH_EQ = HTDBH_EQ,
DBH = dbh,
Dbw = Dbw))
# Chunk 8
tree_ht <- tree %>%
pivot_longer(cols=c(HT, HT_PRED_FVS), names_to = "Height_model", values_to = "height_feet") %>%
mutate(Height_model = ifelse(Height_model == "HT", "Observed height", "FVS-predicted height"))
p.ht.fvs <- ggplot(tree_ht, aes(x = height_feet, fill = Height_model)) +
geom_density(alpha = 0.1) +
labs (x = "Height (feet)") +
theme(panel.background = element_rect(fill = "NA"),
axis.line = element_line(color="black"),
legend.title = element_blank(),
legend.position = c(0.8, 0.8))
p.ht.fvs
# Chunk 9
p.ht <- ggplot(tree, aes(x = dbh, y = HT)) +
geom_point() +
stat_smooth() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
p.ht
# Chunk 10
library(lme4)
# Chunk 11
ht.lme <- lmer(HT ~ dbh + (1 | FVSspID/MU/Plot),
data = tree)
summary(ht.lme)
# Chunk 12
AIC(ht.ols, ht.lme)
# Chunk 13
tree <- tree %>%
mutate(HT_PRED_MIXED = predict(ht.lme, tree, re.form = NULL, allow.new.levels = TRUE))
# Chunk 14
p.ht.fvs <- ggplot(tree, aes(x = HT_PRED_FVS, y = (HT-HT_PRED_FVS))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted FVS-NE height (ft)',
y = 'Bias (ft)',
title = "FVS-Northeast")
p.ht.fvs
p.ht.mixed <- ggplot(tree, aes(x = HT_PRED_MIXED, y = (HT-HT_PRED_MIXED))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted random-effects height (ft)',
y = 'Bias (ft)',
title = "Mixed model (fixed + random effects)")
library(patchwork)
p.pred.ht <- (p.ht.fvs + p.ht.mixed)
p.pred.ht
# Chunk 1
library(tidyverse)
# Chunk 2
tree_full <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_TreeData.csv')
ht <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_HeightCrownData.csv')
sp <- read_csv('C://Users//matt//Documents//Arbor//Projects//z_Archived//Penobscot//Penobscot_species_codes.csv')
# Chunk 3
years <- tree_full %>%
group_by(MU) %>%
summarize(last_inv = max(Inv))
tree_last_inv <- inner_join(tree_full, years) %>%
filter(Inv == last_inv)
ht_last_inv <- inner_join(ht, years) %>%
filter(Inv == last_inv) %>%
select(Inv, MU, Plot, TreeNum, HT, BLC, Rad0, Rad90, Rad180, Rad270, Comments) %>%
rename(Comments_ht = Comments)
tree <- full_join(tree_last_inv, ht_last_inv, by = c("MU", "Plot", "TreeNum","Inv")) %>%
select(-c(ExpNum, DClass, last_inv))
tree <- full_join(tree, sp, by = c("USFSspID")) %>%
drop_na(KCode) %>%
select(-c(SpeciesName)) %>%
filter(dbh >= 4.5)
# Chunk 4
# Select only live trees
tree <- tree %>%
mutate(KCode1 = str_sub(KCode, 1, -3),
alive1 = ifelse(KCode1 %in% c("1", "2", "3", "4", "5", "7", "9"), 1, 0),
KCode2 = str_sub(KCode, 2, -2),
alive2 = ifelse(KCode2 == "0", 1, 0)) %>%
filter(alive1 == 1 & alive2 == 1)
# Chunk 5
p.ht <- ggplot(tree, aes(x = dbh, y = HT, col = FVSspID)) +
geom_point() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
p.ht
# Chunk 1
library(tidyverse)
# Chunk 2
tree_full <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_TreeData.csv')
ht <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_HeightCrownData.csv')
sp <- read_csv('C://Users//matt//Documents//Arbor//Projects//z_Archived//Penobscot//Penobscot_species_codes.csv')
# Chunk 3
years <- tree_full %>%
group_by(MU) %>%
summarize(last_inv = max(Inv))
tree_last_inv <- inner_join(tree_full, years) %>%
filter(Inv == last_inv)
ht_last_inv <- inner_join(ht, years) %>%
filter(Inv == last_inv) %>%
select(Inv, MU, Plot, TreeNum, HT, BLC, Rad0, Rad90, Rad180, Rad270, Comments) %>%
rename(Comments_ht = Comments)
tree <- full_join(tree_last_inv, ht_last_inv, by = c("MU", "Plot", "TreeNum","Inv")) %>%
select(-c(ExpNum, DClass, last_inv))
tree <- full_join(tree, sp, by = c("USFSspID")) %>%
drop_na(KCode) %>%
select(-c(SpeciesName)) %>%
filter(dbh >= 4.5)
# Chunk 4
# Select only live trees
tree <- tree %>%
mutate(KCode1 = str_sub(KCode, 1, -3),
alive1 = ifelse(KCode1 %in% c("1", "2", "3", "4", "5", "7", "9"), 1, 0),
KCode2 = str_sub(KCode, 2, -2),
alive2 = ifelse(KCode2 == "0", 1, 0)) %>%
filter(alive1 == 1 & alive2 == 1)
# Chunk 5
p.ht <- ggplot(tree, aes(x = dbh, y = HT, col = FVSspID)) +
geom_point() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
p.ht
# Chunk 6
# Species function
FVSNE.SPP <- function(SPP){
if(SPP == 'BF'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'TA'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'WS'){HTDBH_EQ = 'C'; Dbw = 0.2}
else if(SPP == 'RS'){HTDBH_EQ = 'C'; Dbw = 0.2}
else if(SPP == 'RN'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'WP'){HTDBH_EQ = 'C'; Dbw = 0.4}
else if(SPP == 'WC'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'EH'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'RM'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'SM'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'YB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'PB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'GB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'AB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'WA'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'BA'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'QA'){HTDBH_EQ = 'W'; Dbw = 0.3}
else if(SPP == 'BP'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'BT'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'OK'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'EL'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'HH'){HTDBH_EQ = 'W'; Dbw = 0.2}
else{HTDBH_EQ = 'W'; Dbw = 0.1}
return(c(HTDBH_EQ = HTDBH_EQ, Dbw = Dbw))}
# Chunk 7
#FVS HT-DBH (Table 4.1.1 in FVS-NE guide)
FVSNE.HTDBH <- function(SPP,HTDBH_EQ,DBH,Dbw){
if(SPP=='BF'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='TA'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RN'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WP'){ca_a1=2108.8442; ca_a2=5.6595; ca_a3=-0.1856; w_a1=4.609; w_a2=-6.1896}
else if(SPP=='WC'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='EH'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RM'){ca_a1=268.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
else if(SPP=='SM'){ca_a1=209.8555; ca_a2=2.9528; ca_a3=-0.3679; w_a1=4.4834; w_a2=-4.5431}
else if(SPP=='YB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='PB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='GB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='AB'){ca_a1=526.1393; ca_a2=3.8923; ca_a3=-0.2259; w_a1=4.4772; w_a2=-4.7206}
else if(SPP=='WA'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='BA'){ca_a1=178.9308; ca_a2=4.9286; ca_a3=-0.6378; w_a1=4.6155; w_a2=-6.2945}
else if(SPP=='QA'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2= -4.9918}
else if(SPP=='BP'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2= -6.4497}
else if(SPP=='BT'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='OK'){ca_a1=196.0565; ca_a2=3.0067; ca_a3=-0.385; w_a1=4.5225; w_a2=-4.9401}
else if(SPP=='EL'){ca_a1=1005.8067; ca_a2=4.6474; ca_a3=-0.2034; w_a1=4.3744; w_a2=-4.5257}
else if(SPP=='HH'){ca_a1=109.7324; ca_a2=2.2503; ca_a3=-0.413; w_a1=4.0322; w_a2=-3.0833}
else{ca_a1=68.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
HT = ifelse(HTDBH_EQ =="C" & DBH < 3.0,(4.5+ca_a1*exp(-1*ca_a2*3**ca_a3)-4.51*(DBH-Dbw)/(3-Dbw))+4.51,
ifelse(HTDBH_EQ =="C" & DBH >= 3.0,4.5+ca_a1*exp(-1*ca_a2*DBH**ca_a3),
4.5+exp(w_a1+w_a2/(DBH+1))))
return(HT=HT)}
aa <- sapply(tree$FVSspID, FVSNE.SPP)
tree <- tree %>%
mutate(HTDBH_EQ = t(aa)[,1],
Dbw = as.numeric(t(aa)[,2]),
HT_PRED_FVS = mapply(FVSNE.HTDBH, SPP = FVSspID,
HTDBH_EQ = HTDBH_EQ,
DBH = dbh,
Dbw = Dbw))
ggplot(tree, aes(x = dbh, y = HT, col = FVSspID)) +
geom_point() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
tree_ht <- tree %>%
pivot_longer(cols=c(HT, HT_PRED_FVS), names_to = "Height_model", values_to = "height_feet") %>%
mutate(Height_model = ifelse(Height_model == "HT", "Observed height", "FVS-predicted height"))
ggplot(tree_ht, aes(x = height_feet, fill = Height_model)) +
geom_density(alpha = 0.1) +
labs (x = "Height (feet)") +
theme(panel.background = element_rect(fill = "NA"),
axis.line = element_line(color="black"),
legend.title = element_blank(),
legend.position = c(0.8, 0.8))
ggplot(tree, aes(x = dbh, y = HT)) +
geom_point() +
stat_smooth() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
p.ht.fvs <- ggplot(tree, aes(x = HT_PRED_FVS, y = (HT-HT_PRED_FVS))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted FVS-NE height (ft)',
y = 'Bias (ft)',
title = "FVS-Northeast")
p.ht.mixed <- ggplot(tree, aes(x = HT_PRED_MIXED, y = (HT-HT_PRED_MIXED))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted random-effects height (ft)',
y = 'Bias (ft)',
title = "Mixed model (fixed + random effects)")
library(patchwork)
(p.ht.fvs + p.ht.mixed)
library(patchwork)
p.ht.fvs + p.ht.mixed
# Chunk 1
library(tidyverse)
# Chunk 2
tree_full <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_TreeData.csv')
ht <- read_csv('C://Users//matt//Documents//Arbor//Data//Penobscot//Data//PEF_CompartmentStudy_HeightCrownData.csv')
sp <- read_csv('C://Users//matt//Documents//Arbor//Projects//z_Archived//Penobscot//Penobscot_species_codes.csv')
# Chunk 3
years <- tree_full %>%
group_by(MU) %>%
summarize(last_inv = max(Inv))
tree_last_inv <- inner_join(tree_full, years) %>%
filter(Inv == last_inv)
ht_last_inv <- inner_join(ht, years) %>%
filter(Inv == last_inv) %>%
select(Inv, MU, Plot, TreeNum, HT, BLC, Rad0, Rad90, Rad180, Rad270, Comments) %>%
rename(Comments_ht = Comments)
tree <- full_join(tree_last_inv, ht_last_inv, by = c("MU", "Plot", "TreeNum","Inv")) %>%
select(-c(ExpNum, DClass, last_inv))
tree <- full_join(tree, sp, by = c("USFSspID")) %>%
drop_na(KCode) %>%
select(-c(SpeciesName)) %>%
filter(dbh >= 4.5)
# Chunk 4
# Select only live trees
tree <- tree %>%
mutate(KCode1 = str_sub(KCode, 1, -3),
alive1 = ifelse(KCode1 %in% c("1", "2", "3", "4", "5", "7", "9"), 1, 0),
KCode2 = str_sub(KCode, 2, -2),
alive2 = ifelse(KCode2 == "0", 1, 0)) %>%
filter(alive1 == 1 & alive2 == 1)
# Chunk 5
ggplot(tree, aes(x = dbh, y = HT, col = FVSspID)) +
geom_point() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
# Chunk 6
# Species function
FVSNE.SPP <- function(SPP){
if(SPP == 'BF'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'TA'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'WS'){HTDBH_EQ = 'C'; Dbw = 0.2}
else if(SPP == 'RS'){HTDBH_EQ = 'C'; Dbw = 0.2}
else if(SPP == 'RN'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'WP'){HTDBH_EQ = 'C'; Dbw = 0.4}
else if(SPP == 'WC'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'EH'){HTDBH_EQ = 'C'; Dbw = 0.1}
else if(SPP == 'RM'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'SM'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'YB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'PB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'GB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'AB'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'WA'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'BA'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'QA'){HTDBH_EQ = 'W'; Dbw = 0.3}
else if(SPP == 'BP'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'BT'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'OK'){HTDBH_EQ = 'W'; Dbw = 0.2}
else if(SPP == 'EL'){HTDBH_EQ = 'W'; Dbw = 0.1}
else if(SPP == 'HH'){HTDBH_EQ = 'W'; Dbw = 0.2}
else{HTDBH_EQ = 'W'; Dbw = 0.1}
return(c(HTDBH_EQ = HTDBH_EQ, Dbw = Dbw))}
# Chunk 7
#FVS HT-DBH (Table 4.1.1 in FVS-NE guide)
FVSNE.HTDBH <- function(SPP,HTDBH_EQ,DBH,Dbw){
if(SPP=='BF'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='TA'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RS'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RN'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='WP'){ca_a1=2108.8442; ca_a2=5.6595; ca_a3=-0.1856; w_a1=4.609; w_a2=-6.1896}
else if(SPP=='WC'){ca_a1=2163.9468; ca_a2=6.2688; ca_a3=-0.2161; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='EH'){ca_a1=266.4562; ca_a2=3.9931; ca_a3=-0.386; w_a1=4.5084; w_a2=-6.0116}
else if(SPP=='RM'){ca_a1=268.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
else if(SPP=='SM'){ca_a1=209.8555; ca_a2=2.9528; ca_a3=-0.3679; w_a1=4.4834; w_a2=-4.5431}
else if(SPP=='YB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='PB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='GB'){ca_a1=170.5253; ca_a2=2.6883; ca_a3=-0.4008; w_a1=4.4388; w_a2=-4.0872}
else if(SPP=='AB'){ca_a1=526.1393; ca_a2=3.8923; ca_a3=-0.2259; w_a1=4.4772; w_a2=-4.7206}
else if(SPP=='WA'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='BA'){ca_a1=178.9308; ca_a2=4.9286; ca_a3=-0.6378; w_a1=4.6155; w_a2=-6.2945}
else if(SPP=='QA'){ca_a1=337.6685; ca_a2=3.6273; ca_a3=-0.3208; w_a1=4.5128; w_a2= -4.9918}
else if(SPP=='BP'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2= -6.4497}
else if(SPP=='BT'){ca_a1=91.3528; ca_a2=6.9961; ca_a3=-1.2294; w_a1=4.5959; w_a2=-6.4497}
else if(SPP=='OK'){ca_a1=196.0565; ca_a2=3.0067; ca_a3=-0.385; w_a1=4.5225; w_a2=-4.9401}
else if(SPP=='EL'){ca_a1=1005.8067; ca_a2=4.6474; ca_a3=-0.2034; w_a1=4.3744; w_a2=-4.5257}
else if(SPP=='HH'){ca_a1=109.7324; ca_a2=2.2503; ca_a3=-0.413; w_a1=4.0322; w_a2=-3.0833}
else{ca_a1=68.5564; ca_a2=3.1143; ca_a3=-0.2941; w_a1=4.3379; w_a2=-3.8214}
HT = ifelse(HTDBH_EQ =="C" & DBH < 3.0,(4.5+ca_a1*exp(-1*ca_a2*3**ca_a3)-4.51*(DBH-Dbw)/(3-Dbw))+4.51,
ifelse(HTDBH_EQ =="C" & DBH >= 3.0,4.5+ca_a1*exp(-1*ca_a2*DBH**ca_a3),
4.5+exp(w_a1+w_a2/(DBH+1))))
return(HT=HT)}
aa <- sapply(tree$FVSspID, FVSNE.SPP)
tree <- tree %>%
mutate(HTDBH_EQ = t(aa)[,1],
Dbw = as.numeric(t(aa)[,2]),
HT_PRED_FVS = mapply(FVSNE.HTDBH, SPP = FVSspID,
HTDBH_EQ = HTDBH_EQ,
DBH = dbh,
Dbw = Dbw))
# Chunk 8
tree_ht <- tree %>%
pivot_longer(cols=c(HT, HT_PRED_FVS), names_to = "Height_model", values_to = "height_feet") %>%
mutate(Height_model = ifelse(Height_model == "HT", "Observed height", "FVS-predicted height"))
ggplot(tree_ht, aes(x = height_feet, fill = Height_model)) +
geom_density(alpha = 0.1) +
labs (x = "Height (feet)") +
theme(panel.background = element_rect(fill = "NA"),
axis.line = element_line(color="black"),
legend.title = element_blank(),
legend.position = c(0.8, 0.8))
# Chunk 9
p.ht <- ggplot(tree, aes(x = dbh, y = HT)) +
geom_point() +
stat_smooth() +
labs (x = "Tree diameter (inches)",
y = "Tree height (feet)")
p.ht
# Chunk 10
library(lme4)
# Chunk 11
ht.lme <- lmer(HT ~ dbh + (1 | FVSspID/MU/Plot),
data = tree)
summary(ht.lme)
# Chunk 12
tree <- tree %>%
mutate(HT_PRED_MIXED = predict(ht.lme, tree, re.form = NULL, allow.new.levels = TRUE))
# Chunk 13
p.ht.fvs <- ggplot(tree, aes(x = HT_PRED_FVS, y = (HT-HT_PRED_FVS))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted FVS-NE height (ft)',
y = 'Bias (ft)',
title = "FVS-Northeast")
p.ht.mixed <- ggplot(tree, aes(x = HT_PRED_MIXED, y = (HT-HT_PRED_MIXED))) +
geom_point() +
stat_smooth(se = F) +
labs(x = 'Predicted random-effects height (ft)',
y = 'Bias (ft)',
title = "Mixed model (fixed + random effects)")
library(patchwork)
p.ht.fvs + p.ht.mixed
p.ht.fvs <- ggplot(tree, aes(x = HT_PRED_FVS, y = (HT-HT_PRED_FVS))) +
geom_point() +
stat_smooth(se = F) +
scale_y_continuous(limits = c(-50, 30)) +
labs(x = 'Predicted FVS-NE height (ft)',
y = 'Bias (ft)',
title = "FVS-Northeast")
p.ht.mixed <- ggplot(tree, aes(x = HT_PRED_MIXED, y = (HT-HT_PRED_MIXED))) +
geom_point() +
stat_smooth(se = F) +
scale_y_continuous(limits = c(-50, 30)) +
labs(x = 'Predicted random-effects height (ft)',
y = 'Bias (ft)',
title = "Mixed model (fixed + random effects)")
library(patchwork)
p.ht.fvs + p.ht.mixed
